/**
 * 积分公式数据
 * 包含预定义的四面体积分公式及其描述
 */
const FORMULAS = {
  "ORDER1POINT4": {
    "data": [
      [0.0, 0.0, 0.0, 0.0416666666666667],
      [1.0, 0.0, 0.0, 0.0416666666666667],
      [0.0, 1.0, 0.0, 0.0416666666666667],
      [0.0, 0.0, 1.0, 0.0416666666666667]
    ],
    "description": "节点总数为 4, 代数精度为 1"
  },
  "ORDER4POINT23": {
    "data": [
      [0.0, 0.0, 0.0, 0.0002166018029373],
      [1.0, 0.0, 0.0, 0.0002166018029373],
      [0.0, 1.0, 0.0, 0.0002166018029373],
      [0.0, 0.0, 1.0, 0.0002166018029373],
      [0.0, 0.5, 0.0, 0.0012522181731302],
      [0.5, 0.5, 0.0, 0.0012522181731302],
      [0.5, 0.0, 0.0, 0.0012522181731302],
      [0.0, 0.0, 0.5, 0.0012522181731302],
      [0.5, 0.0, 0.5, 0.0012522181731302],
      [0.0, 0.5, 0.5, 0.0012522181731302],
      [0.25, 0.25, 0.25, 0.0507936507936508],
      [0.1885804846964451, 0.1885804846964451, 0.0, 0.0089577749685405],
      [0.0, 0.1885804846964451, 0.1885804846964451, 0.0089577749685405],
      [0.1885804846964451, 0.0, 0.1885804846964451, 0.0089577749685405],
      [0.1885804846964451, 0.1885804846964451, 0.6228390306071099, 0.0089577749685405],
      [0.6228390306071099, 0.1885804846964451, 0.1885804846964451, 0.0089577749685405],
      [0.1885804846964451, 0.6228390306071099, 0.1885804846964451, 0.0089577749685405],
      [0.6228390306071099, 0.1885804846964451, 0.0, 0.0089577749685405],
      [0.1885804846964451, 0.6228390306071099, 0.0, 0.0089577749685405],
      [0.0, 0.6228390306071099, 0.1885804846964451, 0.0089577749685405],
      [0.0, 0.1885804846964451, 0.6228390306071099, 0.0089577749685405],
      [0.6228390306071099, 0.0, 0.1885804846964451, 0.0089577749685405],
      [0.1885804846964451, 0.0, 0.6228390306071099, 0.0089577749685405]
    ],
    "description": "节点总数为 23, 代数精度为 4"
  },
  "ORDER7POINT50_v1": {
    "data": [
      [0.0, 0.0, 0.0, 0.000214360866805],
      [1.0, 0.0, 0.0, 0.000214360866805],
      [0.0, 1.0, 0.0, 0.000214360866805],
      [0.0, 0.0, 1.0, 0.000214360866805],
      [0.2928294047674109, 0.0, 0.0, 0.0008268179517797],
      [0.7071705952325891, 0.0, 0.0, 0.0008268179517797],
      [0.0, 0.7071705952325891, 0.0, 0.0008268179517797],
      [0.0, 0.2928294047674109, 0.0, 0.0008268179517797],
      [0.0, 0.0, 0.2928294047674109, 0.0008268179517797],
      [0.0, 0.0, 0.7071705952325891, 0.0008268179517797],
      [0.2928294047674109, 0.0, 0.7071705952325891, 0.0008268179517797],
      [0.7071705952325891, 0.0, 0.2928294047674109, 0.0008268179517797],
      [0.0, 0.2928294047674109, 0.7071705952325891, 0.0008268179517797],
      [0.0, 0.7071705952325891, 0.2928294047674109, 0.0008268179517797],
      [0.2928294047674109, 0.7071705952325891, 0.0, 0.0008268179517797],
      [0.7071705952325891, 0.2928294047674109, 0.0, 0.0008268179517797],
      [0.1972862280257976, 0.1972862280257976, 0.0, 0.0018401779041919],
      [0.0, 0.1972862280257976, 0.1972862280257976, 0.0018401779041919],
      [0.1972862280257976, 0.0, 0.1972862280257976, 0.0018401779041919],
      [0.1972862280257976, 0.1972862280257976, 0.6054275439484048, 0.0018401779041919],
      [0.6054275439484048, 0.1972862280257976, 0.1972862280257976, 0.0018401779041919],
      [0.1972862280257976, 0.6054275439484048, 0.1972862280257976, 0.0018401779041919],
      [0.6054275439484048, 0.1972862280257976, 0.0, 0.0018401779041919],
      [0.1972862280257976, 0.6054275439484048, 0.0, 0.0018401779041919],
      [0.0, 0.6054275439484048, 0.1972862280257976, 0.0018401779041919],
      [0.0, 0.1972862280257976, 0.6054275439484048, 0.0018401779041919],
      [0.6054275439484048, 0.0, 0.1972862280257976, 0.0018401779041919],
      [0.1972862280257976, 0.0, 0.6054275439484048, 0.0018401779041919],
      [0.4256461243139345, 0.4256461243139345, 0.0, 0.0018313243292456],
      [0.0, 0.4256461243139345, 0.4256461243139345, 0.0018313243292456],
      [0.4256461243139345, 0.0, 0.4256461243139345, 0.0018313243292456],
      [0.4256461243139345, 0.4256461243139345, 0.148707751372131, 0.0018313243292456],
      [0.148707751372131, 0.4256461243139345, 0.4256461243139345, 0.0018313243292456],
      [0.4256461243139345, 0.148707751372131, 0.4256461243139345, 0.0018313243292456],
      [0.148707751372131, 0.4256461243139345, 0.0, 0.0018313243292456],
      [0.4256461243139345, 0.148707751372131, 0.0, 0.0018313243292456],
      [0.0, 0.148707751372131, 0.4256461243139345, 0.0018313243292456],
      [0.0, 0.4256461243139345, 0.148707751372131, 0.0018313243292456],
      [0.148707751372131, 0.0, 0.4256461243139345, 0.0018313243292456],
      [0.4256461243139345, 0.0, 0.148707751372131, 0.0018313243292456],
      [0.0950377585839411, 0.0950377585839411, 0.0950377585839411, 0.0075424689046481],
      [0.7148867242481768, 0.0950377585839411, 0.0950377585839411, 0.0075424689046481],
      [0.0950377585839411, 0.7148867242481768, 0.0950377585839411, 0.0075424689046481],
      [0.0950377585839411, 0.0950377585839411, 0.7148867242481768, 0.0075424689046481],
      [0.1252462362578136, 0.1252462362578136, 0.3747537637421864, 0.0136099175597079],
      [0.1252462362578136, 0.3747537637421864, 0.1252462362578136, 0.0136099175597079],
      [0.3747537637421864, 0.1252462362578136, 0.1252462362578136, 0.0136099175597079],
      [0.1252462362578136, 0.3747537637421864, 0.3747537637421864, 0.0136099175597079],
      [0.3747537637421864, 0.1252462362578136, 0.3747537637421864, 0.0136099175597079],
      [0.3747537637421864, 0.3747537637421864, 0.1252462362578136, 0.0136099175597079]
    ],
    "description": "节点总数为 50, 代数精度为 7 (版本1)"
  },
  "ORDER7POINT50_v2": {
    "data": [
      [0.0, 0.0, 0.0, 0.0002321968872349],
      [1.0, 0.0, 0.0, 0.0002321968872349],
      [0.0, 1.0, 0.0, 0.0002321968872349],
      [0.0, 0.0, 1.0, 0.0002321968872349],
      [0.305259875669566, 0.0, 0.0, 0.0007328680241632],
      [0.694740124330434, 0.0, 0.0, 0.0007328680241632],
      [0.0, 0.694740124330434, 0.0, 0.0007328680241632],
      [0.0, 0.305259875669566, 0.0, 0.0007328680241632],
      [0.0, 0.0, 0.305259875669566, 0.0007328680241632],
      [0.0, 0.0, 0.694740124330434, 0.0007328680241632],
      [0.305259875669566, 0.0, 0.694740124330434, 0.0007328680241632],
      [0.694740124330434, 0.0, 0.305259875669566, 0.0007328680241632],
      [0.0, 0.305259875669566, 0.694740124330434, 0.0007328680241632],
      [0.0, 0.694740124330434, 0.305259875669566, 0.0007328680241632],
      [0.305259875669566, 0.694740124330434, 0.0, 0.0007328680241632],
      [0.694740124330434, 0.305259875669566, 0.0, 0.0007328680241632],
      [0.4204599755540437, 0.4204599755540437, 0.0, 0.0025297925981447],
      [0.0, 0.4204599755540437, 0.4204599755540437, 0.0025297925981447],
      [0.4204599755540437, 0.0, 0.4204599755540437, 0.0025297925981447],
      [0.4204599755540437, 0.4204599755540437, 0.1590800488919126, 0.0025297925981447],
      [0.1590800488919126, 0.4204599755540437, 0.4204599755540437, 0.0025297925981447],
      [0.4204599755540437, 0.1590800488919126, 0.4204599755540437, 0.0025297925981447],
      [0.1590800488919126, 0.4204599755540437, 0.0, 0.0025297925981447],
      [0.4204599755540437, 0.1590800488919126, 0.0, 0.0025297925981447],
      [0.0, 0.1590800488919126, 0.4204599755540437, 0.0025297925981447],
      [0.0, 0.4204599755540437, 0.1590800488919126, 0.0025297925981447],
      [0.1590800488919126, 0.0, 0.4204599755540437, 0.0025297925981447],
      [0.4204599755540437, 0.0, 0.1590800488919126, 0.0025297925981447],
      [0.1480462980008327, 0.1480462980008327, 0.0, 0.0015644619233784],
      [0.0, 0.1480462980008327, 0.1480462980008327, 0.0015644619233784],
      [0.1480462980008327, 0.0, 0.1480462980008327, 0.0015644619233784],
      [0.1480462980008327, 0.1480462980008327, 0.7039074039983346, 0.0015644619233784],
      [0.7039074039983346, 0.1480462980008327, 0.1480462980008327, 0.0015644619233784],
      [0.1480462980008327, 0.7039074039983346, 0.1480462980008327, 0.0015644619233784],
      [0.7039074039983346, 0.1480462980008327, 0.0, 0.0015644619233784],
      [0.1480462980008327, 0.7039074039983346, 0.0, 0.0015644619233784],
      [0.0, 0.7039074039983346, 0.1480462980008327, 0.0015644619233784],
      [0.0, 0.1480462980008327, 0.7039074039983346, 0.0015644619233784],
      [0.7039074039983346, 0.0, 0.1480462980008327, 0.0015644619233784],
      [0.1480462980008327, 0.0, 0.7039074039983346, 0.0015644619233784],
      [0.1048645248917035, 0.1048645248917035, 0.1048645248917035, 0.0071279114465646],
      [0.6854064253248895, 0.1048645248917035, 0.1048645248917035, 0.0071279114465646],
      [0.1048645248917035, 0.6854064253248895, 0.1048645248917035, 0.0071279114465646],
      [0.1048645248917035, 0.1048645248917035, 0.6854064253248895, 0.0071279114465646],
      [0.1258796196682507, 0.1258796196682507, 0.3741203803317493, 0.0132167937972054],
      [0.1258796196682507, 0.3741203803317493, 0.1258796196682507, 0.0132167937972054],
      [0.3741203803317493, 0.1258796196682507, 0.1258796196682507, 0.0132167937972054],
      [0.1258796196682507, 0.3741203803317493, 0.3741203803317493, 0.0132167937972054],
      [0.3741203803317493, 0.1258796196682507, 0.3741203803317493, 0.0132167937972054],
      [0.3741203803317493, 0.3741203803317493, 0.1258796196682507, 0.0132167937972054]
    ],
    "description": "节点总数为 50, 代数精度为 7 (版本2)"
  }
};

/**
 * 获取所有可用的积分公式名称
 * @returns {Array} 积分公式名称数组
 */
function getFormulaNames() {
  return Object.keys(FORMULAS);
}

/**
 * 根据名称获取积分公式
 * @param {string} name - 积分公式名称
 * @returns {Object|null} 积分公式对象或null
 */
function getFormula(name) {
  return FORMULAS[name] || null;
}

/**
 * 验证自定义积分公式数据格式
 * @param {Array} data - 自定义积分公式数据
 * @returns {Object} 包含验证结果和错误信息
 */
function validateCustomFormula(data) {
  if (!Array.isArray(data)) {
    return { valid: false, error: "数据必须是数组格式" };
  }
  
  if (data.length === 0) {
    return { valid: false, error: "数组不能为空" };
  }
  
  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    
    if (!Array.isArray(row)) {
      return { valid: false, error: `第 ${i+1} 行不是数组` };
    }
    
    if (row.length !== 4) {
      return { valid: false, error: `第 ${i+1} 行必须包含4个元素 [x,y,z,weight]` };
    }
    
    for (let j = 0; j < 4; j++) {
      if (typeof row[j] !== 'number' || isNaN(row[j])) {
        return { valid: false, error: `第 ${i+1} 行的第 ${j+1} 个元素不是有效数字` };
      }
    }
    
    // 检查权重是否为正数
    if (row[3] <= 0) {
      return { valid: false, error: `第 ${i+1} 行的权重必须为正数` };
    }
  }
  
  // 检查权重总和是否接近1/6 (四面体体积)
  const weightSum = data.reduce((sum, row) => sum + row[3], 0);
  if (Math.abs(weightSum - 1/6) > 0.01) {
    return { 
      valid: true, 
      warning: `权重总和 (${weightSum.toFixed(6)}) 与标准四面体体积 (1/6 ≈ 0.166667) 相差较大，可能影响计算精度`
    };
  }
  
  return { valid: true };
}

/**
 * 添加自定义积分公式
 * @param {string} name - 自定义公式名称
 * @param {Array} data - 积分节点和权重数据
 * @param {string} description - 公式描述
 * @returns {boolean} 是否添加成功
 */
function addCustomFormula(name, data, description = "") {
  if (!name || FORMULAS[name]) {
    return false;
  }
  
  const validation = validateCustomFormula(data);
  if (!validation.valid) {
    return false;
  }
  
  // 如果没有提供描述，自动生成一个
  if (!description) {
    description = `节点总数为 ${data.length}, 自定义积分公式`;
  }
  
  FORMULAS[name] = {
    data: data,
    description: description
  };
  
  return true;
}
